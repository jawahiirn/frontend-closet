#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "ğŸ” Checking for console statements in staged files..."
echo ""

# Get all staged TypeScript/JavaScript files (excluding .husky directory)
# Added || true to prevent script exit if grep finds no matches (set -e behavior)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v '.husky' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No TypeScript/JavaScript files to check"
  echo ""
  exit 0
fi

# Check for console statements
CONSOLE_FOUND=false

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    # Check for console.log, console.warn, console.error, etc.
    MATCHES=$(grep -n -E 'console\.(log|warn|info|debug|trace)' "$FILE" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
      CONSOLE_FOUND=true
      echo "âŒ Console statements found in: ${FILE}"
      echo "$MATCHES"
      echo ""
    fi
  fi
done

if [ "$CONSOLE_FOUND" = true ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT REJECTED!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Reason: Console statements detected in staged files (see above)"
  echo ""
  echo "ğŸ“ What to do:"
  echo "   â€¢ Remove the console statements and try again"
  echo "   â€¢ Add '// eslint-disable-next-line no-console' above specific lines"
  echo "   â€¢ Use 'git commit --no-verify' to bypass this check (not recommended)"
  echo ""
  exit 1
fi

echo "âœ… No console statements found - commit allowed"
echo ""

echo "ğŸ” Running knip to check for unused code..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run knip in pokedex-web directory
# Using a subshell to isolate the directory change
(
  cd pokedex-web || exit 1
  # Capture exit code without triggering set -e exit
  npm run knip && KNIP_EXIT_CODE=0 || KNIP_EXIT_CODE=$?

  echo ""
  if [ $KNIP_EXIT_CODE -ne 0 ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âš ï¸  WARNING: Knip found unused code (see above)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ“ This is informational only - your commit will continue."
    echo "   Please review the unused code and remove it when appropriate."
    echo ""
  else
    echo "âœ… No unused code found"
    echo ""
  fi
)

exit 0
