#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "ğŸ” Checking for console statements in staged files..."
echo ""

# Get all staged TypeScript/JavaScript files (excluding .husky directory)
# Added || true to prevent script exit if grep finds no matches (set -e behavior)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep -v '.husky' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No TypeScript/JavaScript files to check"
  echo ""
  exit 0
fi

# Check for console statements
CONSOLE_FOUND=false

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    # Check for console.log, console.warn, console.error, etc.
    MATCHES=$(grep -n -E 'console\.(log|warn|error|info|debug|trace)' "$FILE" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
      CONSOLE_FOUND=true
      echo "âŒ Console statements found in: ${FILE}"
      echo "$MATCHES"
      echo ""
    fi
  fi
done

if [ "$CONSOLE_FOUND" = true ]; then
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT REJECTED!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Reason: Console statements detected in staged files (see above)"
  echo ""
  echo "ğŸ“ What to do:"
  echo "   â€¢ Remove the console statements and try again"
  echo "   â€¢ Add '// eslint-disable-next-line no-console' above specific lines"
  echo "   â€¢ Use 'git commit --no-verify' to bypass this check (not recommended)"
  echo ""
  exit 1
fi

echo "âœ… No console statements found - commit allowed"
echo ""
exit 0
